#!/bin/bash
#
# Services starting script. (for systemd)
#
# Usage:
#     image_services_start
#

script_name="$(basename $0)"

services=($(env | grep -oP '(?<=^SERVICE_)[a-zA-Z0-9_]*(?==(?i:true|1))'))
services_files=($((find /etc/systemd/system -name *.service -exec basename {} \;; find /usr/lib/systemd/system -name *.service -exec basename {} \;) | sort -u))

start_services="$(for service_var in ${services[@],,} ; do
    service_mask=$(echo $service_var | sed 's/_/.?/g')
    service_name=$(echo " ${services_files[@]} " | grep -oP "(?<= )$service_mask(?=.service )")

    if $(echo $service_name | grep -q ' '); then
        >&2 echo "${script_name}: Duplicate services: $(echo $service_name)"
        exit 1
    fi

    if [ -z "$service_name" ]; then
        >&2 echo "${script_name}: Service $service_var not found"
        exit 1
    fi

    echo $service_name.service
done
)"

echo systemctl start $start_services
systemctl start $start_services
