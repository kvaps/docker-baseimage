#!/bin/bash
#
# Updates installing script.
#
# Usage:
#     image_update [DIRECTORY] [CONFIG]
#

script_name="$(basename $0)"
config_name="version.conf"
updates_name="update"
version_env=$VERSION

# Checking updates dir
if [ ! -z $1 ]; then
    updates_dir="$1"
elif [ -d $updates_name ]; then
    updates_dir="$updates_name"
elif [ -d /etc/image/$updates_name ]; then
    updates_dir="/etc/image/$updates_name"
fi

# Checking version config
if [ ! -z $2 ]; then
    config_file="$2"
elif [ -f $config_name ]; then
    config_file="$config_name"
else
    config_file="/etc/image/$config_name"
fi

# Error if updates directory not found
if [ ! -d "$updates_dir" ]; then
    [ -z $updates_dir ] && unset $updates_dir
    >&2 echo "${script_name}: Cannot load ${updates_dir:=$updates_name}: directory does not exist."
    exit 1
fi

if [ ! -e "$config_file" ]; then
    if [ ! -z $version_env ]; then
        config_version=$version_env
        echo "$version_env" > "$config_file"
    else
        >&2 echo "${script_name}: ${config_name}: file does not exist, and \$VERSION variable is not set"
        exit 1
    fi
else
    config_version=$(cat "$config_file" 2> /dev/null)
fi

updates=($(ls -1v "$updates_dir"))

act_updates=($(
    act_update=false
    for update in "${updates[@]}" ; do
        [ "$config_version" == "$update" ] && act_update=true
        [ "$act_update" == "true" ] && echo $update
    done
))

install_updates=($(
    if [ ! -z "${act_updates}" ]; then
        echo "${act_updates[@]:1}"
    elif [ ! -f $config_file ]; then
        echo "${updates[@]}"
    else
        >&2 echo "${script_name}: Current version file \"$config_version\" does found in $updates_dir"
        exit 1
    fi
))

# Installing updates
for update in "${install_updates[@]}" ; do
    if [ "$update" != "$config_version" ]; then
        echo "Installing update: ${update}"
        ${updates_dir}/${update}
        echo "$update" > $config_file
    fi
done
