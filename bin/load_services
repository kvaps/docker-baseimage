#!/bin/bash
#
# Services loading script.
#
# Usage:
#     load_services [DIRECTORY] [CONFIG]
#

script_name="$(basename $0)"
config_name="supervisord.conf"
config_path="/etc/supervisor/conf.d"
services_name="services"

# Checking services dir
if [ ! -z $1 ]; then
    services_dir="$1"
elif [ -d $services_name ]; then
    services_dir="$services_name"
elif [ -d /etc/$services_name ]; then
    services_dir="/etc/$services_name"
fi

# Checking config
if [ ! -z $2 ]; then
    config_file="$2"
elif [ -d $config_path ]; then
    config_file="$config_path/$config_name"
else
    config_file="supervisord.conf"
fi

# Create config
if [ ! -d $config_file ]; then
    touch $config_file || exit 1
else
    >&2 echo "${script_name}: Error $config_file is directory."
exit 1
fi

#  Write main section
cat > $config_file <<EOT
[supervisord]
nodaemon=true

EOT

# Error if services directory not found
if [ ! -d "$services_dir" ]; then
    [ -z $services_dir ] && unset $services_dir
    >&2 echo "${script_name}: Cannot load ${services_dir:=$services_name}: directory does not exist."
    exit 1
fi

services=($(env | grep -oP '(?<=^SERVICE_)[a-zA-Z0-9_]*(?==(?i:true|1))'))

for service_var in ${services[@],,} ; do
    service_mask=$(echo $service_var | sed 's/_/.?/g')
    service_name=$(ls $services_dir -1 | grep -iP "$service_mask")

    if $(echo $service_name | grep -q ' '); then
        >&2 echo "${script_name}: Duplicate services: $(echo $service_name)"
        exit 1
    fi

    if [ -z "$service_name" ]; then
        >&2 echo "${script_name}: Service $service_var not found in $services_dir"
        exit 1
    fi

    service_runit="$services_dir/$service_name/$service_name.runit"

    if [ ! -f $service_runit ]; then
        >&2 echo "${script_name}: File $service_var.runit not found in $services_dir/$service_name/"
        exit 1
    fi

    # Write service to config
    cat >> $config_file <<EOT
[program:${service_name}]
command=${service_runit}

EOT

done
