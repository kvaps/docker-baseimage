#!/bin/bash
#
# Services loading script.
#
# Usage:
#     load_services [DIRECTORY]
#

services_name="services"

# Checking config
if [ ! -z $1 ]; then
    services_dir="$1"
elif [ -d $services_name ]; then
    services_dir="$services_name"
elif [ -d /etc/$services_name ]; then
    services_dir="/etc/$services_name"
fi

# Error if config not found
if [ ! -d "$services_dir" ]; then
    [ -z $services_dir ] && unset $services_dir
    >&2 echo "$0: Cannot load ${services_dir:=$services_name}: directory does not exist."
    exit 1
fi

services=($(env | grep -oP '(?<=^SERVICE_)[a-zA-Z0-9_]*(?==(?i:true|1))'))

for service_var in ${services[@],,} ; do
    service_mask=$(echo $service_var | sed 's/_/.?/g')
    service_name=$(ls $services_dir -1 | grep -iP "$service_mask")

    if $(echo $service_name | grep -q ' '); then
        >&2 echo "$0: Duplicate services: $(echo $service_name)"
        exit 1
    fi

    if [ -z "$service_name" ]; then
        >&2 echo "$0: Service $service_var not found in $services_dir"
        exit 1
    fi

    service_runit="$services_dir/$service_name/$service_name.runit"

    if [ ! -f $service_runit ]; then
        >&2 echo "$0: File $service_var.runit not found in $services_dir/$service_name/"
        exit 1
    fi

done
